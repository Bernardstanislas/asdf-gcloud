#!/usr/bin/env bash

set -euo pipefail

# shellcheck source=../lib/utils.bash
source "$(dirname "$0")/../lib/utils.bash"

download() {
    local gcs_bucket_name="cloud-sdk-release"
    local gcs_object="${1}"
    local tmp_download_dir="${2}"

    printf "‚è¨  downloading %s\\n" "${gcs_object}"
    curl -X GET \
        -o "${tmp_download_dir}/${gcs_object}" \
        "https://storage.googleapis.com/storage/v1/b/${gcs_bucket_name}/o/${gcs_object}?alt=media"
    printf "‚úÖ  downloaded!\\n"
}

verify() {
    local gcs_tar_location="${1}"

    printf "üî¨  verifying %s\\n" "${gcs_tar_location}"
    # TODO: check file md5
    #   - fetch metadata
    #   - check md5 value
    printf "‚úÖ  verified!\\n"
}

extract() {
    local gcs_tar_location="${1}"

    printf "üì¶  extracting...\\n"
    tar -zxf "${gcs_tar_location}" -C "${ASDF_INSTALL_PATH}" --strip-components=1
    printf "‚úÖ  extracted!\\n"
}

install_gcloud() {
    printf "üöß  installing...\\n"
    printf "    ‚ö†Ô∏è  CLOUDSDK_PYTHON must be set in you shell profile\\n"
    "${ASDF_INSTALL_PATH}/install.sh" --usage-reporting=false --path-update=false --quiet
    printf "‚úÖ  gcloud %s installed!\\n" "${ASDF_INSTALL_VERSION}"
    # TODO: instruct on setup of shell completions. This should be some form of ".asdf/installs/gcloud/$version/completions
}

setup() {
    tmp_download_dir=$(mktemp -d -t 'asdf_gcloud_XXXXXX')
    trap 'rm -rf "${tmp_download_dir}"' EXIT

    gcs_object="google-cloud-sdk-${ASDF_INSTALL_VERSION}-$(get_os_name)-$(get_os_architecture).tar.gz"

    download "${gcs_object}" "${tmp_download_dir}"

    verify "${tmp_download_dir}/${gcs_object}"

    extract "${tmp_download_dir}/${gcs_object}"

    install_gcloud
}

# TODO: handle both types in - "${ASDF_INSTALL_TYPE}"
setup
