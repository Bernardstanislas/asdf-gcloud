#!/usr/bin/env bash

set -euo pipefail

# shellcheck source=../lib/utils.bash
source "$(dirname "$0")/../lib/utils.bash"

install_gcloud() {
    local asdf_install_type="$1"
    local asdf_install_version="$2"
    local asdf_install_path="$3"
    local gcs_bucket_name="cloud-sdk-release"
    local os_name
    os_name=$(get_os_name)
    local os_architecture
    os_architecture=$(get_os_architecture)

    printf "++++++++++++++++++\\n"
    printf "‚ÑπÔ∏è  type:\\t\\t%s\\n" "${asdf_install_type}"
    printf "‚ÑπÔ∏è  version:\\t\\t%s\\n" "${asdf_install_version}"
    printf "‚ÑπÔ∏è  install path:\\t%s\\n" "${asdf_install_path}"
    printf "‚ÑπÔ∏è  os name:\\t\\t%s\\n" "${os_name}"
    printf "‚ÑπÔ∏è  os arch:\\t\\t%s\\n" "${os_architecture}"
    printf "++++++++++++++++++\\n"

    printf "üîç  finding gcloud version\\n"
    gcs_object="google-cloud-sdk-${asdf_install_version}-${os_name}-${os_architecture}.tar.gz"

    printf "‚è¨  downloading... %s\\n" "${gcs_object}"
    tmp_download_dir="$(mktemp -d -t 'asdf_gcloud_XXXXXX')"
    trap 'rm -rf "${tmp_download_dir}"' EXIT
    if [[ -e "${tmp_download_dir}/${gcs_object}" ]]; then
        printf "‚úÖ  using cached download!\\n"
    else
        curl -X GET \
            -o "${tmp_download_dir}/${gcs_object}" \
            "https://storage.googleapis.com/storage/v1/b/${gcs_bucket_name}/o/${gcs_object}?alt=media"
        printf "‚úÖ  downloaded!\\n"
    fi
    printf "üì¶  extracting...\\n"
    tar -zxf "${tmp_download_dir}/${gcs_object}" -C "${asdf_install_path}" --strip-components=1
    printf "‚úÖ  extracted!\\n"
    printf "üöß  installing...\\n"
    printf "    ‚ö†Ô∏è  CLOUDSDK_PYTHON must be set in you shell profile\\n"
    "${asdf_install_path}/install.sh" --usage-reporting=false --path-update=false --quiet
    printf "‚úÖ  gcloud %s installed!\\n" "${asdf_install_version}"
    # TODO: instruct on setup of shell completions. This should be some form of ".asdf/installs/gcloud/$version/completions
}

# shellcheck disable=SC2153
install_gcloud "${ASDF_INSTALL_TYPE}" "${ASDF_INSTALL_VERSION}" "${ASDF_INSTALL_PATH}"
